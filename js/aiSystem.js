/**
 * æˆ˜é”¤40K - é¢„è®¾å¯¹è¯ç³»ç»Ÿï¼ˆçº¯é¢„è®¾ç‰ˆï¼‰
 * å»æ‰AIæ¨¡å—ï¼Œä½¿ç”¨å¤§é‡é¢„è®¾å¯¹è¯æ¨åŠ¨å‰§æƒ…
 * æ‰€æœ‰å‰§æƒ…é€šè¿‡é¢„è®¾æ–‡æœ¬å±•ç¤º
 */

// ============================================
// å‰§æƒ…å¯¹è¯åº“ï¼ˆæ‰©å±•ç‰ˆï¼‰
// ============================================

const NPC_DIALOGUES = {
    // å¡”å§†çš„å¯¹è¯ï¼ˆæ ¹æ®æ··æ²Œå€¼å’Œå¥½æ„Ÿåº¦å˜åŒ–ï¼‰
    tam: {
        // åˆå§‹å¯¹è¯ï¼ˆä½å¥½æ„Ÿåº¦ï¼‰
        low_trust: [
            "å¤§äººï¼Œæˆ‘æ˜¨æ™šç¡®å®åœ¨ä»“åº“é™„è¿‘å·¡é€»ï¼Œä½†ä»€ä¹ˆéƒ½æ²¡çœ‹åˆ°ã€‚å¸çš‡åœ¨ä¸Šï¼Œæˆ‘å¯¹å¸å›½å¿ å¿ƒè€¿è€¿ï¼",
            "æœ€è¿‘è¥åœ°é‡Œå¼¥æ¼«ç€ä¸€è‚¡å¥‡æ€ªçš„å‘³é“...åƒæ˜¯çƒ§ç„¦çš„è‚‰ï¼Œåˆåƒæ˜¯æŸç§åŒ–å­¦è¯å‰‚ã€‚",
            "æˆ‘ã€æˆ‘çœŸçš„ä»€ä¹ˆéƒ½æ²¡çœ‹åˆ°ï¼æ±‚æ‚¨ä¸è¦ç”¨é‚£ç§çœ¼ç¥çœ‹æˆ‘...",
            "è¿™å‡ å¤©çš„æ°”æ°›å¤ªè¯¡å¼‚äº†...æ··æ²Œ...æ‚¨æ˜¯è¯´æ··æ²Œå—ï¼Ÿå¤©å“ªï¼Œæˆ‘ä»¬ä¸­é—´çœŸçš„æœ‰æ··æ²Œä¿¡å¾’ï¼Ÿ",
            "å¸çš‡ä¿ä½‘...æˆ‘æœ€è¿‘æ€»æ˜¯åšå™©æ¢¦ï¼Œæ¢¦è§è‡ªå·±è¢«ä»€ä¹ˆä¸œè¥¿åå™¬äº†...",
            "è¯·æ‚¨ç›¸ä¿¡æˆ‘ï¼Œå¤§äººï¼æˆ‘è™½ç„¶å®³æ€•ï¼Œä½†æˆ‘ç»ä¸ä¼šèƒŒå›å¸å›½ï¼"
        ],
        // ä¸­ç­‰å¥½æ„Ÿåº¦
        medium_trust: [
            "å¤§äººï¼Œæˆ‘æƒ³èµ·æ¥äº†...æ˜¨æ™šæˆ‘çœ‹åˆ°å¡å°”åœ¨ä»“åº“é™„è¿‘å¾˜å¾Šï¼Œå¥½åƒåœ¨æ‰¾ä»€ä¹ˆä¸œè¥¿...",
            "è¿™å‡ å¤©æˆ‘ä¸€ç›´åœ¨è§‚å¯Ÿ...å°¤é‡Œçš„è¡Œä¸ºç¡®å®å¾ˆæ€ªå¼‚ï¼Œä»–ç»å¸¸åŠå¤œç‹¬è‡ªå¤–å‡ºã€‚",
            "å¤§äººï¼Œæˆ‘æœ€è¿‘æ”¶åˆ°ä¸€å°åŒ¿åä¿¡ï¼Œè¯´å†…é¬¼å°±åœ¨æˆ‘ä»¬ä¸­é—´...æˆ‘å®³æ€•æäº†ã€‚",
            "å¦‚æœ...å¦‚æœçœŸçš„æœ‰æ··æ²Œä¿¡å¾’ï¼Œæ‚¨ä¼šä¿æŠ¤æˆ‘ä»¬å—ï¼Ÿå¤§äººï¼Œæˆ‘æŠŠè‡ªå·±äº¤ç»™ä½ äº†ã€‚",
            "æ˜¨æ™šæˆ‘å¬åˆ°ä»“åº“é‚£è¾¹æœ‰åŠ¨é™ï¼Œåƒæ˜¯é‡‘å±ç¢°æ’çš„å£°éŸ³...ä½†ç­‰æˆ‘èµ¶å»æ—¶ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰äº†ã€‚"
        ],
        // é«˜å¥½æ„Ÿåº¦
        high_trust: [
            "å¤§äººï¼æˆ‘å‘ç°äº†é‡è¦çº¿ç´¢ï¼åœ¨ä»“åº“çš„åœ°ä¸‹å®¤é‡Œï¼Œæˆ‘æ‰¾åˆ°äº†è¿™ä¸ª...",
            "æˆ‘æ„¿æ„ä¸ºæ‚¨èµ´æ±¤è¹ˆç«ï¼Œå¤§äººï¼ä¸ç®¡å†…é¬¼æ˜¯è°ï¼Œæˆ‘ä»¬ä¸€èµ·æ‰¾å‡ºä»–ï¼",
            "å¤§äººï¼Œæˆ‘å·²ç»ç§˜å¯†è°ƒæŸ¥è¿‡äº†ã€‚æ‰€æœ‰çš„è¯æ®éƒ½æŒ‡å‘...æˆ‘ä¸èƒ½è¯´å‡ºæ¥ï¼Œæ€•æ‰“è‰æƒŠè›‡ã€‚",
            "æ„Ÿè°¢æ‚¨å¯¹æˆ‘çš„ä¿¡ä»»ï¼Œå¤§äººã€‚æˆ‘å‘èª“ï¼Œç”¨æˆ‘çš„ç”Ÿå‘½ä¿æŠ¤æ‚¨å’Œå¸å›½ï¼",
            "æˆ‘çŸ¥é“ä¸€æ¡ç§˜å¯†é€šé“ï¼Œå¯ä»¥ç»•è¿‡å®ˆå«...å¦‚æœæˆ‘ä»¬éœ€è¦æŠ“å†…é¬¼ï¼Œé‚£ä¼šæ˜¯å…³é”®ã€‚"
        ]
    },

    // å¡å°”çš„å¯¹è¯
    carl: {
        low_trust: [
            "ç‰©èµ„æ¸…å•ï¼Ÿç­‰ç­‰ï¼Œæˆ‘éœ€è¦æ ¸å¯¹ä¸€ä¸‹...æœ€è¿‘çš„è¡¥ç»™ç¡®å®å‡ºäº†ç‚¹é—®é¢˜ï¼Œä½†è¿™ä¸æ˜¯æˆ‘çš„é”™ï¼",
            "æˆ‘ä¸ºå¸å›½æ•ˆåŠ›äºŒåå¹´ï¼æ‚¨æ€€ç–‘æˆ‘ï¼Ÿå¥½å•Šï¼Œæ¥æŸ¥å•Šï¼æˆ‘èº«æ­£ä¸æ€•å½±å­æ–œï¼",
            "æœ€è¿‘è¡¥ç»™çº¿è¢«åˆ‡æ–­ï¼Œä¸Šé¢å·²ç»çŸ¥é“äº†ã€‚è¿™æ¬¡çš„æŸå¤±...å‘ƒï¼Œåº”è¯¥ä¸æ˜¯æˆ‘çš„è´£ä»»å§ï¼Ÿ",
            "ä»€ä¹ˆï¼Ÿæ‚¨è¯´ç‰©èµ„çŸ­ç¼ºï¼Ÿå‘ƒ...è¿™ä¸ªå˜›...å…¶å®æ˜¯æœ‰åŸå› çš„ï¼æ‚¨å¬æˆ‘è§£é‡Šï¼",
            "æˆ‘æ¯å¤©éƒ½åœ¨åŠªåŠ›å·¥ä½œï¼Œä»æ—©åˆ°æ™š...æ‚¨çœ‹æˆ‘çš„é»‘çœ¼åœˆï¼Œå°±æ˜¯æœ€å¥½çš„è¯æ˜ï¼"
        ],
        medium_trust: [
            "å¤§äººï¼Œæˆ‘å¯èƒ½çŸ¥é“ä¸€äº›å…³äºå†…é¬¼çš„äº‹æƒ…...ä½†æˆ‘éœ€è¦å…ˆç¡®è®¤æ‚¨çš„èº«ä»½...",
            "ä»“åº“é‡Œçš„æƒ…å†µå¾ˆå¤æ‚...æœ‰äº›äº‹æƒ…ï¼Œæ‚¨çŸ¥é“äº†åè€Œä¸å¥½ã€‚å¤§äººï¼Œç›¸ä¿¡æˆ‘ã€‚",
            "å“...å…¶å®æˆ‘æœ€è¿‘ä¹Ÿå¾ˆå›°æƒ‘ã€‚æ„Ÿè§‰æœ‰äººåœ¨æš—ä¸­ç›¯ç€æˆ‘...æ‚¨è¯´æ˜¯æ··æ²Œå—ï¼Ÿ",
            "è¿™äº›ç‰©èµ„...æˆ‘æ€»æ„Ÿè§‰å“ªé‡Œä¸å¯¹ã€‚ä½†æ¯æ¬¡æ£€æŸ¥éƒ½æ²¡æœ‰é—®é¢˜...å¤ªè¯¡å¼‚äº†ï¼",
            "å¤§äººï¼Œæˆ‘æœ€è¿‘å‘ç°ä¸€äº›å¯ç–‘çš„ç‰©èµ„æµåŠ¨...ä½†æˆ‘æ²¡æœ‰è¯æ®ï¼Œä¸æ•¢ä¹±è¯´ã€‚"
        ],
        high_trust: [
            "å¤§äººï¼çœŸç›¸åªæœ‰ä¸€ä¸ªï¼æ‰€æœ‰çš„è¯æ®éƒ½æŒ‡å‘å°¤é‡Œï¼ä»–åœ¨åˆ©ç”¨æœºæ¢°æ•™çš„èº«ä»½åšæ©æŠ¤ï¼",
            "æˆ‘æ„¿æ„é…åˆæ‚¨ï¼Œå¤§äººï¼ä¸ºäº†å¸å›½ï¼Œæˆ‘æ„¿æ„çŒ®å‡ºä¸€åˆ‡ï¼",
            "æˆ‘æŸ¥åˆ°å†…é¬¼çš„ç‰©èµ„æ¥æºäº†...é€šè¿‡ä¸€ä¸ªç§˜å¯†è´¦æˆ·...å¤§äººï¼Œæ‚¨çœ‹è¿™ä¸ªï¼",
            "æ„Ÿè°¢æ‚¨ç›¸ä¿¡æˆ‘ï¼Œå¤§äººï¼æˆ‘è¿™è¾ˆå­æœ€æ­£ç¡®çš„å†³å®šå°±æ˜¯è¿½éšæ‚¨ï¼",
            "å¤§äººï¼Œæˆ‘å·²ç»å¸ƒç½®å¥½äº†ã€‚åªè¦å†…é¬¼æœ‰æ‰€è¡ŒåŠ¨ï¼Œæˆ‘ä»¬å°±èƒ½å½“åœºæŠ“ä½ä»–ï¼"
        ]
    },

    // å°¤é‡Œçš„å¯¹è¯
    yuri: {
        low_trust: [
            "èµç¾æ¬§å§†å°¼èµ›äºšï¼æœºæ¢°å³æ˜¯çœŸç†ï¼Œè¡€è‚‰ä¸è¿‡æ˜¯è„†å¼±çš„èº¯å£³ã€‚",
            "è¿™å…·èº«èº¯å·²ç»æ”¹é€ äº†87%ï¼Œæˆ‘å‡ ä¹ä¸å†æ˜¯äººç±»...è¿™æ˜¯è¿›åŒ–çš„å¿…ç„¶ï¼",
            "è¡€è‚‰è‹¦å¼±ï¼Œæœºæ¢°é£å‡ã€‚è¿™æ˜¯æˆ‘ä»¬æœºæ¢°æ•™çš„çœŸç†ï¼Œæ‚¨éš¾é“ä¸æ˜ç™½å—ï¼Ÿ",
            "æœ€è¿‘çš„çµèƒ½æ³¢åŠ¨å¾ˆå¼‚å¸¸...æˆ‘æ„Ÿå—åˆ°äº†æŸäº›ä¸œè¥¿ï¼Œæ­£åœ¨é»‘æš—ä¸­çª¥è§†ã€‚",
            "æˆ‘çš„æœºæ¢°ä¹‰çœ¼èƒ½å¤Ÿçœ‹åˆ°ä½ ä»¬çœ‹ä¸åˆ°çš„ä¸œè¥¿...æ¯”å¦‚çµé­‚çš„æ‰­æ›²ã€‚"
        ],
        medium_trust: [
            "æ··æ²Œï¼Ÿå“¼ï¼Œæ··æ²Œä¸è¿‡æ˜¯å¦ä¸€ç§å½¢å¼çš„èƒ½é‡ã€‚å…³é”®æ˜¯èƒ½å¦æ§åˆ¶å®ƒã€‚",
            "æœ‰æœºç”Ÿå‘½ä½“æ€»æ˜¯è¢«æƒ…æ„Ÿå·¦å³...è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ ä»¬ä¼šå¤±è´¥ã€‚ã€‚",
            "å¤§äººï¼Œæ‚¨çŸ¥é“å—ï¼Ÿæˆ‘èƒ½çœ‹åˆ°æ··æ²Œçš„è§¦é¡»æ­£åœ¨å‘è¿™åº§è¥åœ°è”“å»¶...",
            "æƒ³è¦åœ¨è¿™ä¸ªæ—¶ä»£ç”Ÿå­˜ï¼Œå°±è¦æŠ›å¼ƒè½¯å¼±çš„èº«ä½“ã€‚æ¥å—æœºæ¢°æ”¹é€ å§ï¼",
            "å¸çš‡...å“¼ï¼Œå¸çš‡åˆèƒ½ç»™æˆ‘ä»¬ä»€ä¹ˆï¼Ÿåªæœ‰æœºæ¢°æ‰æ˜¯æ°¸æ’çš„ï¼"
        ],
        high_trust: [
            "å¤§äºº...æˆ‘å¿…é¡»å‘Šè¯‰æ‚¨çœŸç›¸ã€‚æˆ‘æœ€è¿‘å‘ç°äº†æ··æ²Œè…èš€çš„è¯æ®...å°±åœ¨æˆ‘ä»¬çš„æŒ‡æŒ¥å®˜èº«ä¸Šï¼",
            "æ„Ÿè°¢æ‚¨çš„ä¿¡ä»»ï¼Œå¤§äººã€‚æˆ‘æ„¿æ„ç”¨æˆ‘çš„æœºæ¢°ä¹‹å¿ƒä¸ºæ‚¨æœåŠ¡ï¼",
            "æˆ‘çš„ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°äº†å¼‚å¸¸èƒ½é‡æ³¢åŠ¨...æ¥æºæ˜¯...å¤©å“ªï¼Œæ˜¯å†›æ¢°åº“ï¼",
            "å¤§äººï¼Œæˆ‘æ„¿æ„é…åˆæ‚¨çš„ä¸€åˆ‡è¡ŒåŠ¨ã€‚æœºæ¢°æ•™çš„åŠ›é‡ï¼Œå°±æ˜¯æ‚¨çš„åŠ›é‡ï¼",
            "æˆ‘ç»ˆäºæ‰¾åˆ°äº†ï¼æ··æ²Œè…èš€çš„æºå¤´...å°±åœ¨è¿™ä¸ªè¥åœ°çš„æœ€æ·±å¤„..."
        ]
    }
};

// ============================================
// å‰§æƒ…é˜¶æ®µå¯¹è¯ï¼ˆæ¨åŠ¨å‰§æƒ…å‘å±•ï¼‰
// ============================================

const STORY_PHASES = {
    // é˜¶æ®µ1ï¼šå¼€åœº
    opening: {
        elena: [
            "å˜¿ï¼Œå°é¬¼ï¼Œä½ é†’äº†ã€‚",
            "æˆ‘æ˜¯ä¼Šè²å¨œ...è™½ç„¶æˆ‘ä»¬å¤±æ•£å¤šå¹´ï¼Œä½†æˆ‘ä¸€ç›´åœ¨æš—ä¸­çœ‹ç€ä½ ã€‚",
            "ç°åœ¨ï¼Œä½ èº«å¤„éº¦åŠ æ‰˜æ™®â€”â€”ä¸€é¢—æ­£åœ¨è¢«æ··æ²Œåå™¬çš„æ˜Ÿçƒã€‚",
            "ä½ çš„ä»»åŠ¡æ˜¯å®Œæˆå¡ç‰Œä»»åŠ¡ï¼Œæ‰¾å‡ºå†…é¬¼ï¼Œä¿æŠ¤è¥åœ°ï¼Œç›´åˆ°æ´å†›åˆ°æ¥ã€‚",
            "ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"å¼€å§‹å§ã€‚è®°ä½ï¼Œæ··æ²Œå°±åœ¨ä½ èº«è¾¹..."
        ],
        system: [
            "ä½ çå¼€çœ¼ç›ï¼Œå‘ç°è‡ªå·±èººåœ¨ä¸€ç‰‡åºŸå¢Ÿä¹‹ä¸­ã€‚",
            "ä½œä¸ºæé™æˆ˜å£«ï¼Œä½ è§è¿‡å¤ªå¤šæˆ˜åœºï¼Œä½†éº¦åŠ æ‰˜æ™®çš„æ²¦é™·é€Ÿåº¦è¿œè¶…ä½ çš„é¢„æ–™ã€‚",
            "æ··æ²Œçš„è…åŒ–å¦‚åŒæ¯’æ¶²ï¼Œå·²ç»æ¸—é€è¿›è¿™ä¸ªæ˜Ÿçƒçš„æ¯ä¸€ä¸ªè§’è½ã€‚",
            "ä½ çš„é€šè®¯å™¨ä¼ æ¥æ–­æ–­ç»­ç»­çš„ä¿¡å·ï¼š'...éœ€è¦...æ”¯æ´...æ··æ²Œå·²ç»...'",
            "ä½ å¿…é¡»æŒ¯ä½œèµ·æ¥ã€‚æ¯ä¸€å¼ å¡ç‰Œä»»åŠ¡éƒ½æ˜¯ä¸€æ¬¡è€ƒéªŒã€‚"
        ]
    },

    // é˜¶æ®µ2ï¼šç¬¬ä¸€æ¬¡å‘ç°çº¿ç´¢
    first_clue: {
        elena: [
            "å°é¬¼ï¼Œä½ åšå¾—ä¸é”™ã€‚",
            "ä½†è¿™åªæ˜¯å¼€å§‹...æ··æ²Œæ¯”ä½ æƒ³è±¡çš„è¦ç‹¡çŒ¾å¾—å¤šã€‚",
            "ç»§ç»­è°ƒæŸ¥ï¼Œä½ ä¼šæœ‰æ›´å¤šå‘ç°çš„ã€‚"
        ],
        system: [
            "åœ¨è°ƒæŸ¥è¿‡ç¨‹ä¸­ï¼Œä½ å‘ç°äº†ä¸€äº›å¯ç–‘çš„ç—•è¿¹ã€‚",
            "åœ°ä¸Šæœ‰è¢«æ‹–æ‹½çš„ç—•è¿¹ï¼Œå¢™å£ä¸Šæœ‰ç€å¥‡æ€ªçš„ç¬¦å·...",
            "è¿™ä¸æ˜¯æ™®é€šçš„æ··ä¹±...è¿™æ˜¯æœ‰ç»„ç»‡çš„æ··æ²Œæ´»åŠ¨ï¼"
        ]
    },

    // é˜¶æ®µ3ï¼šå‘ç°å†…é¬¼è¯æ®
    evidence_found: {
        elena: [
            "å“¦ï¼Ÿæœ‰æ„æ€...",
            "ä½ æ‰¾åˆ°äº†ä¸€äº›æœ‰è¶£çš„ä¸œè¥¿ï¼Œå¯¹å§ï¼Ÿ",
            "ä¸è¦å£°å¼ ï¼Œå°é¬¼ã€‚æˆ‘ä»¬è¦æŠ“ä¸ªç°è¡Œã€‚",
            "æ‰¾å‡ºè°æ˜¯çœŸå‡¶ï¼Œä½†ä¸è¦æ‰“è‰æƒŠè›‡ã€‚"
        ],
        system: [
            "ä½ çš„è°ƒæŸ¥æœ‰äº†é‡å¤§å‘ç°ï¼",
            "åœ¨ä»“åº“çš„éšè”½è§’è½é‡Œï¼Œä½ å‘ç°äº†ä¸€ä¸ªæ··æ²Œå°è®°å’Œå‡ å°å¯†ä¿¡ã€‚",
            "å¯†ä¿¡çš„å†…å®¹æŒ‡å‘äº†æŸä¸ªNPC...ä½†å­—ä½“è¢«æ•…æ„æ¨¡ç³Šäº†ã€‚",
            "å†…é¬¼å°±åœ¨ä½ èº«è¾¹ã€‚ä½ å¿…é¡»æ‰¾å‡ºæ˜¯è°ã€‚"
        ]
    },

    // é˜¶æ®µ4ï¼šçœŸç›¸å¤§ç™½
    truth_revealed: {
        elena: [
            "å¥½äº†ï¼Œå°é¬¼ã€‚",
            "æ˜¯æ—¶å€™ç»“æŸè¿™åœºé—¹å‰§äº†ã€‚",
            "æŒ‡è®¤é‚£ä¸ªå†…é¬¼...ä½†è¦ç¡®ä¿ä½ æ‰¾å¯¹äº†äººã€‚",
            "é”™æ€æ— è¾œä¼šå¢åŠ æ··æ²Œå€¼...ä½ è‡ªå·±çœ‹ç€åŠå§ã€‚"
        ],
        system: [
            "æ‰€æœ‰çš„è¯æ®éƒ½æŒ‡å‘äº†ä¸€ä¸ªäººã€‚",
            "ä½†åœ¨ä½ è¡ŒåŠ¨ä¹‹å‰ï¼Œä½ æƒ³å†ç¡®è®¤ä¸€æ¬¡å—ï¼Ÿ",
            "ä¸€æ—¦æŠ•ç¥¨å¤„å†³ï¼Œå°±æ— æ³•æŒ½å›äº†...",
            "æ··æ²Œåœ¨çœ‹ç€ä½ ã€‚å¸çš‡ä¹Ÿåœ¨çœ‹ç€ä½ ã€‚"
        ]
    },

    // é˜¶æ®µ5ï¼šæ··æ²Œå…¥ä¾µ
    chaos_invasion: {
        elena: [
            "å°é¬¼ï¼æƒ…å†µä¸å¯¹ï¼",
            "æ··æ²Œå¤§å†›æ­£åœ¨é€¼è¿‘ï¼",
            "ä¸æ˜¯å†…é¬¼çš„é—®é¢˜äº†...æ˜¯å…¨é¢çš„è¿›æ”»ï¼",
            "å‡†å¤‡æˆ˜æ–—ï¼ä¸ºäº†ç”Ÿå­˜ï¼"
        ],
        system: [
            "è­¦æŠ¥å£°åˆ’ç ´äº†å¤œç©ºï¼",
            "æ··æ²Œå†›é˜Ÿä»å››é¢å…«æ–¹æ¶Œæ¥ï¼",
            "è¥åœ°é­åˆ°äº†è¢­å‡»ï¼",
            "è¿™æ˜¯ä½ æœ€åçš„è€ƒéªŒ...è¦ä¹ˆæˆ˜èƒœæ··æ²Œï¼Œè¦ä¹ˆè¢«æ··æ²Œåå™¬ã€‚"
        ]
    },

    // é˜¶æ®µ6ï¼šèƒœåˆ©/å¤±è´¥
    ending: {
        victory: [
            "æ··æ²Œé€€å»äº†ã€‚",
            "ä½ åšåˆ°äº†ï¼Œå°é¬¼ã€‚",
            "éº¦åŠ æ‰˜æ™®å¾—æ•‘äº†...è‡³å°‘æš‚æ—¶å¦‚æ­¤ã€‚",
            "å¸çš‡ä¼šè®°ä½ä½ çš„åŠŸç»©çš„ã€‚"
        ],
        defeat: [
            "æ··æ²Œä¾µèš€äº†ä½ ã€‚",
            "ä½ çš„æ„è¯†å¼€å§‹æ¨¡ç³Š...",
            "ä¸...è¿™ä¸åº”è¯¥æ˜¯ç»“å±€...",
            "ä½†æ··æ²Œ...æ··æ²Œæ˜¯æ°¸æ’çš„..."
        ]
    }
};

// ============================================
// ä»»åŠ¡å®Œæˆå¯¹è¯
// ============================================

const TASK_COMPLETION = {
    success: {
        chaos: [
            "ä½ æˆåŠŸæ‰¾å‡ºäº†æ··æ²Œçš„é˜´è°‹ï¼å†…é¬¼çš„è¯æ®å·²ç»ç¡®å‡¿ã€‚",
            "å¸çš‡çš„è£å…‰ä¸ä½ åŒåœ¨ï¼ä½ æŒ«è´¥äº†ä¸€æ¬¡æ··æ²Œæ¸—é€ã€‚",
            "ä½ çš„è°ƒæŸ¥è®©æ··æ²Œä¿¡å¾’æ— æ‰€éå½¢ã€‚å¹²å¾—å¥½ï¼"
        ],
        faith: [
            "ä½ çš„è™”è¯šæ„ŸåŠ¨äº†å¸çš‡ã€‚ç¥åœ£çš„åŠ›é‡åœ¨åº‡æŠ¤ä½ ã€‚",
            "ä½ å®Œæˆäº†å¸çš‡çš„æ—¨æ„ã€‚ä¿¡ä»°çš„ç«ç„°åœ¨ä½ å¿ƒä¸­ç‡ƒçƒ§ã€‚",
            "ä½ çš„ç¥ˆç¥·å¾—åˆ°äº†å›åº”ã€‚å¸å›½çš„åœ£å…‰å°†ç…§äº®å‰è·¯ã€‚"
        ],
        combat: [
            "æ•Œäººå€’åœ¨äº†ä½ çš„é¢å‰ã€‚ä½ æ˜¯å¸å›½çš„åˆ©åˆƒï¼",
            "æˆ˜æ–—ç»“æŸã€‚ä½ ç”¨å‰‘ä¸è¡€è¯æ˜äº†å¸å›½çš„åŠ›é‡ã€‚",
            "åˆä¸€åœºèƒœåˆ©ã€‚æ··æ²Œçš„çˆªç‰™åœ¨ä½ çš„é¢å‰é¢¤æŠ–ã€‚"
        ],
        devotion: [
            "æ–°çš„è¿½éšè€…åŠ å…¥äº†ä½ çš„é˜µè¥ã€‚å›¢ç»“å°±æ˜¯åŠ›é‡ã€‚",
            "ä½ èµ¢å¾—äº†ä¿¡ä»»ã€‚åœ¨è¿™ä¸ªæ®‹é…·çš„ä¸–ç•Œï¼ŒåŒä¼´æ˜¯æœ€çè´µçš„è´¢å¯Œã€‚",
            "åˆä¸€ä¸ªäººæ„¿æ„ä¸ä½ å¹¶è‚©ä½œæˆ˜ã€‚å¸å›½çš„ç«ç§æ­£åœ¨ä¼ é€’ã€‚"
        ]
    },
    failure: {
        chaos: [
            "æ··æ²Œçš„é˜´å½±æ­£åœ¨è”“å»¶...ä½ çš„è°ƒæŸ¥æ²¡æœ‰å–å¾—è¿›å±•ã€‚",
            "å†…é¬¼ä¾ç„¶é€é¥æ³•å¤–ã€‚æ··æ²Œåœ¨æš—å¤„å˜²ç¬‘ä½ çš„æ— èƒ½ã€‚",
            "ä½ çš„è¿Ÿç–‘ç»™äº†æ•Œäººå¯ä¹˜ä¹‹æœºã€‚æ··æ²Œå€¼å¢åŠ äº†ã€‚"
        ],
        faith: [
            "ä½ çš„ç¥ˆç¥·æ²¡æœ‰å¾—åˆ°å›åº”ã€‚å¸çš‡åœ¨æ³¨è§†ç€ä½ ...ä½†ä½ è®©ä»–å¤±æœ›äº†ã€‚",
            "ä¿¡ä»°çš„ç«ç„°åœ¨é£ä¸­æ‘‡æ›³ã€‚å®ƒéœ€è¦æ›´å¤šçš„ç‡ƒæ–™ã€‚",
            "ä½ çš„è™”è¯šä¸å¤Ÿåšå®šã€‚é‡æ–°ç¥ˆç¥·å§ï¼Œæˆ˜å£«ã€‚"
        ],
        combat: [
            "æ•Œäººé€ƒèµ°äº†ã€‚ä½ è®©å¸å›½çš„åˆ©åˆƒè’™ç¾ã€‚",
            "æˆ˜æ–—å¤±è´¥äº†ã€‚æ··æ²Œçš„çˆªç‰™ç»§ç»­è‚†è™ã€‚",
            "ä½ çš„å‰‘ä¸å¤Ÿå¿«ã€‚åœ¨æˆ˜åœºä¸Šï¼ŒçŠ¹è±«å°±æ˜¯æ­»äº¡ã€‚"
        ],
        devotion: [
            "æ²¡æœ‰äººæ„¿æ„ä¿¡ä»»ä½ ã€‚å­¤ç‹¬æ˜¯å¼ºè€…çš„å®¿å‘½ã€‚",
            "è¿½éšè€…ç¦»å¼€äº†ã€‚ä»–ä»¬è§‰å¾—ä½ ä¸å¤Ÿå¼ºå¤§ã€‚",
            "ä½ ä¾ç„¶æ˜¯å­¤èº«ä¸€äººã€‚è¿™å°±æ˜¯å¼±è€…çš„ä»£ä»·ã€‚"
        ]
    }
};

// ============================================
// åŠŸèƒ½å‡½æ•°
// ============================================

/**
 * è·å–NPCå¯¹è¯
 */
function getNPCDialogue(npcId, trustLevel = 5) {
    const npc = NPC_DIALOGUES[npcId];
    if (!npc) return "è¿™ä¸ªNPCæ²¡æœ‰å¯¹è¯ã€‚";

    // æ ¹æ®ä¿¡ä»»åº¦é€‰æ‹©å¯¹è¯ç±»å‹
    let type = 'low_trust';
    if (trustLevel >= 8) type = 'high_trust';
    else if (trustLevel >= 5) type = 'medium_trust';

    const dialogues = npc[type];
    return dialogues[Math.floor(Math.random() * dialogues.length)];
}

/**
 * è·å–å‰§æƒ…é˜¶æ®µå¯¹è¯
 */
function getStoryPhaseDialogue(phase, type = 'system') {
    const phaseData = STORY_PHASES[phase];
    if (!phaseData) return "æ²¡æœ‰è¿™ä¸ªé˜¶æ®µçš„å¯¹è¯ã€‚";

    const dialogues = phaseData[type];
    if (!dialogues) return "æ²¡æœ‰è¿™ä¸ªç±»å‹çš„å¯¹è¯ã€‚";

    return dialogues[Math.floor(Math.random() * dialogues.length)];
}

/**
 * è·å–ä»»åŠ¡å®Œæˆå¯¹è¯
 */
function getTaskCompletionDialogue(taskType, isSuccess) {
    const type = isSuccess ? 'success' : 'failure';
    const dialogues = TASK_COMPLETION[type][taskType];
    if (!dialogues) return isSuccess ? "ä»»åŠ¡å®Œæˆï¼" : "ä»»åŠ¡å¤±è´¥ã€‚";

    return dialogues[Math.floor(Math.random() * dialogues.length)];
}

/**
 * è·å–ä¼Šè²å¨œçš„éšæœºæç¤º
 */
function getElenaTip(topic) {
    const tips = {
        card: [
            "æ¯å¼ å¡ç‰Œéƒ½ä»£è¡¨ç€ä¸€æ¬¡æœºé‡æˆ–æŒ‘æˆ˜ã€‚é€‰æ‹©æ—¶è¦æƒ³æ¸…æ¥šåæœã€‚",
            "æ··æ²Œå¡ã€ä¿¡ä»°å¡ã€æˆ˜æ–—å¡ã€çœ·å±å¡...æ¯ç§éƒ½æœ‰å…¶ç‹¬ç‰¹çš„ä½œç”¨ã€‚",
            "ä¸è¦æ€¥äºå®Œæˆä»»åŠ¡ã€‚æœ‰æ—¶å€™ï¼Œç­‰å¾…ä¹Ÿæ˜¯ä¸€ç§ç­–ç•¥ã€‚"
        ],
        chaos: [
            "æ··æ²Œå€¼è¶Šé«˜ï¼Œä½ çœ‹åˆ°çš„'çœŸç›¸'å°±è¶Šä¸å¯ä¿¡ã€‚",
            "å½“æ··æ²Œå€¼è¶…è¿‡50æ—¶ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›...ä¸å­˜åœ¨çš„ä¸œè¥¿ã€‚",
            "ä¿æŒç†æ™ºæ˜¯æ´»ä¸‹å»çš„å…³é”®ã€‚æ··æ²Œæ˜¯æ•Œäººæœ€å¤§çš„æ­¦å™¨ã€‚"
        ],
        strategy: [
            "è¿½éšè€…å¯ä»¥å¸®åŠ©ä½ æˆ˜æ–—ã€‚æ‹›å‹Ÿä»–ä»¬ï¼Œä½†è¦å°å¿ƒå†…é¬¼ã€‚",
            "èµ„æºå¾ˆé‡è¦ï¼Œä½†ä¸è¦ä¸ºäº†èµ„æºæ”¾å¼ƒç†æ™ºã€‚",
            "æ¯å¼ å¡ç‰Œä»»åŠ¡éƒ½æœ‰æ—¶é™ã€‚è¶…æ—¶ä¼šæœ‰æƒ©ç½šã€‚"
        ],
        general: [
            "ç‚¹å‡»'å¼€å§‹ä»»åŠ¡'å¼€å§‹ä½ çš„å†’é™©ã€‚",
            "å®Œæˆä»»åŠ¡è·å¾—å¥–åŠ±ï¼Œå¤±è´¥ä¼šå¢åŠ æ··æ²Œå€¼ã€‚",
            "æ‰¾å‡ºå†…é¬¼æ˜¯å–èƒœçš„å…³é”®ã€‚ä½†è¦è¯æ®ç¡®å‡¿å†è¡ŒåŠ¨ã€‚"
        ]
    };

    const topicTips = tips[topic] || tips.general;
    return topicTips[Math.floor(Math.random() * topicTips.length)];
}

// ============================================
// å‰§æƒ…è¿›åº¦ç³»ç»Ÿ
// ============================================

let storyProgress = {
    phase: 'opening',       // å½“å‰å‰§æƒ…é˜¶æ®µ
    cluesFound: 0,          // å‘ç°çš„çº¿ç´¢æ•°é‡
    evidenceCollected: false, // æ˜¯å¦æ”¶é›†åˆ°å…³é”®è¯æ®
    npcTrust: {             // NPCå¥½æ„Ÿåº¦
        tam: 5,
        carl: 3,
        yuri: 2
    },
    tasksCompleted: 0,      // å®Œæˆçš„ä»»åŠ¡æ•°
    chaosLevel: 0           // å½“å‰æ··æ²Œç­‰çº§
};

/**
 * æ£€æŸ¥å‰§æƒ…è¿›åº¦å¹¶è§¦å‘é˜¶æ®µå˜åŒ–
 */
function checkStoryProgress() {
    const progress = storyProgress;

    // ä»å¼€åœºåˆ°å‘ç°çº¿ç´¢
    if (progress.phase === 'opening' && progress.tasksCompleted >= 2) {
        progress.phase = 'first_clue';
        return true;
    }

    // ä»å‘ç°çº¿ç´¢åˆ°è¯æ®ç¡®å‡¿
    if (progress.phase === 'first_clue' && progress.cluesFound >= 3) {
        progress.phase = 'evidence_found';
        progress.evidenceCollected = true;
        return true;
    }

    // ä»è¯æ®ç¡®å‡¿åˆ°çœŸç›¸å¤§ç™½
    if (progress.phase === 'evidence_found' && progress.evidenceCollected) {
        // å½“ç©å®¶æ”¶é›†åˆ°è¯æ®åï¼Œå¯ä»¥è¿›å…¥æŠ•ç¥¨é˜¶æ®µ
        progress.phase = 'truth_revealed';
        return true;
    }

    // ä»çœŸç›¸å¤§ç™½åˆ°æ··æ²Œå…¥ä¾µï¼ˆå¦‚æœæ··æ²Œå€¼è¿‡é«˜ï¼‰
    if (progress.phase === 'truth_revealed' && gameState.character.chaos >= 60) {
        progress.phase = 'chaos_invasion';
        return true;
    }

    return false;
}

/**
 * æ¨è¿›å‰§æƒ…ï¼ˆæ’­æ”¾å½“å‰é˜¶æ®µçš„å¯¹è¯ï¼‰
 */
function advanceStory() {
    const phase = storyProgress.phase;

    // æ£€æŸ¥æ˜¯å¦åº”è¯¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
    const shouldAdvance = checkStoryProgress();
    if (shouldAdvance) {
        // æ’­æ”¾æ–°é˜¶æ®µçš„ç³»ç»Ÿå¯¹è¯
        addDialog('system', 'ğŸ“œ', getStoryPhaseDialogue(phase, 'system'));
    }

    return shouldAdvance;
}

/**
 * å®Œæˆä»»åŠ¡åæ›´æ–°å‰§æƒ…è¿›åº¦
 */
function onTaskCompleted(taskType, success) {
    storyProgress.tasksCompleted++;

    if (taskType === 'chaos' && success) {
        storyProgress.cluesFound++;
    }

    // æ’­æ”¾å®Œæˆå¯¹è¯
    addDialog('system', getTaskCompletionDialogue(taskType, success));

    // å°è¯•æ¨è¿›å‰§æƒ…
    advanceStory();
}

// ============================================
// å¯¼å‡ºå‡½æ•°åˆ°å…¨å±€
// ============================================

window.aiSystem = {
    generateNPCDialogue: async function(npcId) {
        // ç®€åŒ–ï¼šç›´æ¥ä½¿ç”¨é¢„è®¾å¯¹è¯
        const trustLevel = storyProgress.npcTrust[npcId] || 5;
        return getNPCDialogue(npcId, trustLevel);
    },

    generateElenaTip: async function(topic) {
        return getElenaTip(topic);
    },

    generateEventDescription: async function(card) {
        // ä½¿ç”¨é¢„è®¾çš„äº‹ä»¶æå†™
        const events = PRESETS.events[card.type] || PRESETS.events.combat;
        return events[Math.floor(Math.random() * events.length)];
    },

    getDialogue: function(type, subtype) {
        if (type === 'npc') {
            return getNPCDialogue(subtype, storyProgress.npcTrust[subtype] || 5);
        }
        if (type === 'story') {
            return getStoryPhaseDialogue(subtype, 'system');
        }
        if (type === 'elena') {
            return getStoryPhaseDialogue(subtype, 'elena');
        }
        return 'æ²¡æœ‰æ‰¾åˆ°å¯¹è¯ã€‚';
    }
};

// å¯¼å‡ºè¿›åº¦ç³»ç»Ÿ
window.storyProgress = storyProgress;
window.advanceStory = advanceStory;
window.checkStoryProgress = checkStoryProgress;
window.onTaskCompleted = onTaskCompleted;
